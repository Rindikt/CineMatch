name: CineMatch Orchestrator (CI/CD)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: üß™ Run Integrated Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –¥–ª—è Docker Compose
      # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ –∏ –≤ —Ç–≤–æ–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ
      - name: Create .env file
        run: |
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
          echo "DB_URL=postgresql+asyncpg://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}" >> .env
          echo "REDIS_URL=redis://redis:6379/0" >> .env
          echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" >> .env

      # 2. –ü–æ–¥–Ω–∏–º–∞–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (Postgres, Redis, API) –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π docker-compose.yml, —á—Ç–æ–±—ã —Å—Ä–µ–¥–∞ –±—ã–ª–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π
      - name: Build and Run Tests
        run: |
          docker compose up --build --exit-code-from tests tests

      - name: Stop services
        if: always()
        run: docker compose down

  build_push:
    name: üöÄ Build and Push to Docker Hub
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ API (–æ–Ω –∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Celery –≤–æ—Ä–∫–µ—Ä–æ–≤)
      - name: Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cinematch-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ø–∞–ø–∫–∞ frontend —Å Dockerfile
      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cinematch-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  simulate_deploy:
    name: üèÅ Deployment Readiness
    needs: build_push
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "SUCCESS: CineMatch ecosystem is validated and delivered to Docker Hub."
          echo "To deploy: docker compose pull && docker compose up -d"